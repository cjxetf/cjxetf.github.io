# 文本分类 Agent 优化
构建一个高准确度的文本分类 Agent（如意图识别、工单分类、情感判断等），不能仅依赖“训练一个模型就上线”，而应打造一个**数据驱动、模型智能、推理鲁棒、反馈闭环、持续进化**的系统。以下从六大维度系统阐述提升准确度的关键手段，并重点融入 **badcase 微调、prompt 自动迭代、线上监控与人工分析闭环** 三大核心能力。

---

## 一、数据层面：夯实基础，覆盖长尾

1. **高质量标注**
  * 制定清晰标签定义，多人标注 + Kappa 一致性校验
  * 覆盖边界案例（如“你们真快！”是表扬还是反讽？）
2. **数据增强与平衡**
  * 同义替换、回译、对抗样本生成提升泛化
  * 使用 Focal Loss 或重采样解决类别不平衡
3. **引入外部知识**
  * 行业关键词表、正则规则作为特征或后处理依据
  * 结合知识图谱消歧（如“苹果”指公司还是水果）
4. **动态扩充 badcase 数据集**
  * 将线上错误样本自动加入训练集，形成“越用越准”的飞轮

---

## 二、模型层面：选型合理，微调精准

1. **按场景选模型**
  * 小规模任务：FastText / BERT-base
  * 高精度需求：DeBERTa / XLM-R
  * 大模型 Agent：Qwen / LLaMA / Doubao + LoRA 微调
2. **指令微调（Instruction Tuning）**
  * 统一 prompt 格式，提升大模型 zero-shot/few-shot 能力
    ```
    请判断用户消息属于哪一类：【咨询】【投诉】【表扬】
    “客服电话打不通！” →
    ```
3. **集成与蒸馏**
  * 模型融合（BERT + 规则 + LightGBM）
  * 大模型蒸馏为小模型，兼顾精度与推理效率
4. **Badcase 驱动的增量微调**
  * 定期收集低置信度/人工修正样本
  * 使用课程学习或对抗训练针对性优化
  * 防止灾难性遗忘（保留原数据子集联合训练）

---

## 三、推理与决策：不止于“最大概率”

1. **置信度阈值控制**
  * 若 max(prob) < 0.7，返回“不确定”或转人工
2. **规则后处理兜底**
  * 关键词强制映射（如含“起诉”→“投诉”）
  * 逻辑校验（同一会话意图应一致）
3. **上下文感知**
  * 利用对话历史（前 N 轮）辅助当前分类
4. **不确定性量化**
  * 通过 Monte Carlo Dropout 估计预测可靠性
  * 高不确定性样本进入审核队列

---

## 四、Prompt 与规则的自动演进（关键新增）

当业务新增/调整分类规则时（如新增“账户安全”类），传统重训成本高。我们构建 ​**Prompt 自动迭代优化 pipeline**​：

1. **自动生成候选 Prompt**
   基于新类别定义和示例，由 LLM 生成结构化指令模板。
2. **自动评估机制**
  * 离线：在 mini 验证集上测试准确率/F1
  * 在线：影子模式并行运行，对比历史表现
  * 一致性检查：确保不损害旧类别性能
3. **自我反思优化**
   若效果不佳，触发 LLM 自我修正：
   > “你将‘密码被盗’误判为咨询，请修改逻辑并生成新 prompt。”
4. **快速上线**
   通过验证后，无需重新训练模型，仅更新 prompt 即可生效，​**上线周期从 2 周缩短至 2 小时**​。

---

## 五、线上监控 + 抽检 + 人工分析闭环（关键新增）

构建三层主动防御体系，避免“模型静默失效”：

### ▶ L1：实时指标监控

* 准确率、置信度分布、类别比例突变（如“投诉”激增 50%）
* 自动告警 + 降级到规则引擎

### ▶ L2：自动智能抽检

* 每日随机抽样 + 重点采样（低置信、新词、长尾类）
* 生成 badcase 候选池

### ▶ L3：人工深度标注分析

* 每周 review 200+ 样本，按错误类型打标：
  * [ ] 关键词缺失
  * [x] 语气/情感误判
  * [ ] 多意图混淆
* 输出《分类问题诊断报告》，驱动三端优化：
  * ​**规则库**​：补充关键词/正则
  * ​**训练数据**​：加入代表性 badcase
  * ​**Prompt 指令**​：强调易错逻辑（如“带感叹号的质疑属于投诉”）

> ✅ ​**案例**​：某金融客服系统通过此闭环，在“618”前一周发现“物流延迟”投诉激增，提前扩充样本，避免大促期间分类崩坏。

---

## 六、工程与部署：保障稳定高效

1. **预处理标准化**
  * 统一清洗、分词、截断策略，避免训练/推理不一致
2. **模型压缩与加速**
  * 知识蒸馏、INT8 量化、ONNX 部署
3. **容灾降级**
  * 主模型失败时，切换至轻量规则引擎
4. **A/B 测试与灰度发布**
  * 新模型仅对 5% 流量生效，验证 OK 后全量

---

## 总结：构建自进化的分类 Agent

一个真正高准确度的文本分类 Agent，必须具备以下能力：

| 能力                              | 价值                           |
| ----------------------------------- | -------------------------------- |
| **Badcase 微调**            | 将错误转化为进步，持续提升     |
| **Prompt 自动迭代**         | 快速响应业务变化，降低运维成本 |
| **监控-抽检-分析闭环**      | 主动防御退化，保障 SLA         |
| **规则 + 模型 hybrid 架构** | 兼顾灵活性与鲁棒性             |

> 💡 ​
> “我们不仅训练模型，更构建了一个​**以 badcase 为中心的反馈飞轮**​：自动监控 → 智能抽检 → 人工归因 → 三端协同优化（数据/规则/prompt）→ 影子验证 → 安全上线。这套机制让我们在业务规则月均变更 2 次的情况下，仍保持 95%+ 的线上准确率。”
