# Sentinel æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„é¢å‘åˆ†å¸ƒå¼æœåŠ¡æ¶æ„çš„æµé‡æ²»ç†ç»„ä»¶

## æ ¸å¿ƒæ¨¡å‹ï¼šèµ„æºï¼ˆResourceï¼‰ + è§„åˆ™ï¼ˆRuleï¼‰
Sentinel çš„ä¸€åˆ‡å›´ç»• â€œèµ„æºâ€ å±•å¼€ï¼š

- èµ„æºï¼ˆResourceï¼‰ï¼šä»£è¡¨ä»»ä½•éœ€è¦ä¿æŠ¤çš„é€»è¾‘å•å…ƒ 
  - å¦‚ï¼šä¸€ä¸ª HTTP æ¥å£ /api/order
  - ä¸€ä¸ªæ–¹æ³• OrderService.createOrder()
  - ä¸€ä¸ª Dubbo æœåŠ¡
- è§„åˆ™ï¼ˆRuleï¼‰ï¼šå®šä¹‰å¦‚ä½•ä¿æŠ¤è¯¥èµ„æº
  - é™æµè§„åˆ™ï¼ˆFlowRuleï¼‰
  - ç†”æ–­è§„åˆ™ï¼ˆDegradeRuleï¼‰
  - ç³»ç»Ÿè§„åˆ™ï¼ˆSystemRuleï¼‰
  âœ… ä½¿ç”¨æ–¹å¼ï¼š

```java

// æ–¹å¼1ï¼šæ³¨è§£
@SentinelResource("createOrder")
public void createOrder() { ... }

// æ–¹å¼2ï¼šAPI ç¼–ç 
try (Entry entry = SphU.entry("createOrder")) {
// ä¸šåŠ¡é€»è¾‘
} catch (BlockException e) {
// é™æµ/ç†”æ–­å¤„ç†
}
```
## é™æµç®—æ³•ï¼šæ”¯æŒå¤šç§æ¨¡å¼
Sentinel çš„ FlowRule æ”¯æŒ 5 ç§é™æµæ¨¡å¼ï¼Œåº•å±‚ä½¿ç”¨ä¸åŒç®—æ³•ï¼š

| æ¨¡å¼ï¼ˆgradeï¼‰| ç®—æ³•               | è¯´æ˜                     |
|-------------|--------------------|--------------------------|
| QPSï¼ˆé»˜è®¤ï¼‰| æ»‘åŠ¨çª—å£ + ä»¤ç‰Œæ¡¶   | æ§åˆ¶æ¯ç§’è¯·æ±‚æ•°           |
| çº¿ç¨‹æ•°      | ä¿¡å·é‡ï¼ˆè®¡æ•°å™¨ï¼‰| æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°           |
| Warm Upï¼ˆé¢„çƒ­ï¼‰ | ä»¤ç‰Œæ¡¶ + é¢„çƒ­æ›²çº¿   | å†·å¯åŠ¨æ—¶ç¼“æ…¢æå‡é˜ˆå€¼     |
| æ’é˜Ÿç­‰å¾…    | æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰ | è¶…è¿‡é˜ˆå€¼åˆ™æ’é˜Ÿï¼ŒåŒ€é€Ÿé€šè¿‡ |
| Warm Up + æ’é˜Ÿ | æ··åˆæ¨¡å¼           | é¢„çƒ­ + æ’é˜Ÿ              |
1. QPS é™æµï¼ˆæœ€å¸¸ç”¨ï¼‰
- ç›®æ ‡ï¼šæ¯ç§’æœ€å¤šå¤„ç† N ä¸ªè¯·æ±‚
- å®ç°ï¼š
  - ä½¿ç”¨ æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰ ç»Ÿè®¡æœ€è¿‘ 1 ç§’å†…çš„ QPS
  - æ¯ä¸ªçª—å£åˆ’åˆ†ä¸º å¤šä¸ªå°æ ¼å­ï¼ˆå¦‚ 20 ä¸ª 50ms æ ¼å­ï¼‰
  - æ–°è¯·æ±‚åˆ°æ¥æ—¶ï¼Œåªç»Ÿè®¡ æœ€è¿‘ 1000ms å†…çš„æ ¼å­æ€»å’Œ

2. çº¿ç¨‹æ•°é™æµ
- ç›®æ ‡ï¼šæœ€å¤š N ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œè¯¥èµ„æº
- å®ç°ï¼šåŸå­è®¡æ•°
- âœ… é€‚ç”¨åœºæ™¯ï¼šé˜²æ­¢çº¿ç¨‹æ± è€—å°½ï¼ˆå¦‚æ•°æ®åº“è¿æ¥æ± ç“¶é¢ˆï¼‰

3. Warm Upï¼ˆå†·å¯åŠ¨ï¼‰
- é—®é¢˜ï¼šç³»ç»Ÿåˆšå¯åŠ¨æ—¶ï¼Œç¼“å­˜æœªé¢„çƒ­ã€è¿æ¥æ± æœªå»ºç«‹ï¼Œç›´æ¥æ»¡è´Ÿè·ä¼šå´©æºƒ
- è§£å†³æ–¹æ¡ˆï¼š
  - åˆå§‹é˜ˆå€¼ = threshold / coldFactorï¼ˆé»˜è®¤ coldFactor=3ï¼‰
  - åœ¨ warmUpPeriodSecï¼ˆå¦‚ 10 ç§’ï¼‰å†…ï¼Œçº¿æ€§æå‡åˆ° full threshold
  - ğŸ“ˆ å…¬å¼ï¼šé˜ˆå€¼(t) = threshold Ã— (1 - e^(-kt))ï¼ˆå®é™…ç”¨åˆ†æ®µçº¿æ€§è¿‘ä¼¼ï¼‰

4. æ’é˜Ÿç­‰å¾…ï¼ˆåŒ€é€Ÿå™¨ï¼‰
- ç›®æ ‡ï¼šè¶…è¿‡é˜ˆå€¼ä¸æ‹’ç»ï¼Œè€Œæ˜¯æ’é˜Ÿï¼Œä»¥å›ºå®šé—´éš”æ”¾è¡Œ
- ç®—æ³•ï¼šæ¼æ¡¶ï¼ˆLeaky Bucketï¼‰
  - æ¡¶å®¹é‡ = maxQueueingTimeMsï¼ˆæœ€å¤§æ’é˜Ÿæ—¶é—´ï¼‰ 
  - å‡ºæ°´é€Ÿç‡ = 1000ms / thresholdï¼ˆå¦‚ threshold=5 â†’ æ¯ 200ms æ”¾è¡Œ 1 ä¸ªï¼‰
- æ•ˆæœï¼šå‰Šå³°å¡«è°·ï¼Œè¯·æ±‚åŒ€é€Ÿå¤„ç†

## å®æ—¶æŒ‡æ ‡ç»Ÿè®¡ï¼šé«˜æ€§èƒ½æ— é”è®¾è®¡
Sentinel çš„é«˜æ€§èƒ½å…³é”®åœ¨äº æ— é”æ»‘åŠ¨çª—å£ç»Ÿè®¡ï¼š

1. MetricBucketï¼ˆæŒ‡æ ‡æ¡¶ï¼‰
   - æ¯ä¸ªèµ„æºç»´æŠ¤ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼ˆå¦‚ 40 ä¸ªæ¡¶ï¼‰
   - æ¯ä¸ªæ¡¶è®°å½• 500ms å†…çš„ QPSã€çº¿ç¨‹æ•°ç­‰
   - æ—¶é—´è½®é©±åŠ¨ï¼šæ¯ 500ms æ»šåŠ¨åˆ°ä¸‹ä¸€ä¸ªæ¡¶
2. æ— é”æ›´æ–°
   - ä½¿ç”¨ LongAdderï¼ˆJDK 8+ï¼‰ æ›¿ä»£ AtomicLong
   - å¤šçº¿ç¨‹å†™å…¥æ—¶åˆ†æ•£åˆ°ä¸åŒ Cellï¼Œå‡å°‘ CAS å†²çª
   - è¯»å–æ—¶èšåˆæ‰€æœ‰ Cell å€¼
   - æ€§èƒ½ï¼šå•æœºå¯æ”¯æ’‘ ç™¾ä¸‡çº§ QPS ç»Ÿè®¡ã€‚

## è§„åˆ™ç”Ÿæ•ˆæœºåˆ¶ï¼šåŠ¨æ€ & å®æ—¶
1. è§„åˆ™åŠ è½½
   - å¯åŠ¨æ—¶ä» FlowRuleManager.loadRules() åŠ è½½
   - æ”¯æŒ åŠ¨æ€æ•°æ®æºï¼ˆNacosã€ZooKeeperã€Apolloï¼‰ï¼Œå®æ—¶æ¨é€æ–°è§„åˆ™
2. æ‹¦æˆªæµç¨‹
```text
   [è¯·æ±‚è¿›å…¥]
   â†“
   SphU.entry("resource")
   â†“
   æ£€æŸ¥ FlowSlotï¼ˆé™æµæ’æ§½ï¼‰
   â†“
   æ ¹æ®è§„åˆ™ç±»å‹ï¼ˆQPS/çº¿ç¨‹æ•°ï¼‰è·å–å½“å‰æŒ‡æ ‡
   â†“
   if (å½“å‰æŒ‡æ ‡ > é˜ˆå€¼) {
   è§¦å‘ BlockException
   } else {
   æ”¾è¡Œ + æ›´æ–°æŒ‡æ ‡ç»Ÿè®¡
   }
 ```
3. é›†ç¾¤é™æµï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
   - Sentinel æä¾› Token Server æ¨¡å¼ï¼š
   - æ‰€æœ‰èŠ‚ç‚¹å‘ Token Server ç”³è¯·ä»¤ç‰Œ

## ç†”æ–­é™çº§è§„åˆ™
![img.png](img.png)