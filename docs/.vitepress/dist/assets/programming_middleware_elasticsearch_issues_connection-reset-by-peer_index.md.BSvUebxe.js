import{_ as i,c as a,o as n,a9 as e,ec as t}from"./chunks/framework.Dp2GimK2.js";const c=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"programming/middleware/elasticsearch/issues/connection-reset-by-peer/index.md","filePath":"programming/middleware/elasticsearch/issues/connection-reset-by-peer/index.md","lastUpdated":1765356475000}'),l={name:"programming/middleware/elasticsearch/issues/connection-reset-by-peer/index.md"};function h(p,s,k,r,E,d){return n(),a("div",null,[...s[0]||(s[0]=[e(`<h2 id="异常信息" tabindex="-1">异常信息 <a class="header-anchor" href="#异常信息" aria-label="Permalink to “异常信息”">​</a></h2><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">org.springframework.dao.DataAccessResourceFailureException</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Connection reset by peer; nested exception is java.lang.RuntimeException</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Connection reset by peer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at org.springframework.data.elasticsearch.core.ElasticsearchExceptionTranslator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">translateExceptionIfPossible</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ElasticsearchExceptionTranslator.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">76</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">translateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ElasticsearchRestTemplate.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">378</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Caused by</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.io.IOException</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Connection reset by peer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at org.elasticsearch.client.RestClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">extractAndWrapCause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RestClient.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">828</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at org.elasticsearch.client.RestClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">performRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RestClient.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">248</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at org.elasticsearch.client.RestClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">performRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RestClient.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">235</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at org.elasticsearch.client.RestHighLevelClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">internalPerformRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RestHighLevelClient.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1514</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Caused by</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.io.IOException</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Connection reset by peer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at sun.nio.ch.FileDispatcherImpl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Native Method)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at sun.nio.ch.SocketDispatcher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SocketDispatcher.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">39</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  at sun.nio.ch.IOUtil.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">readIntoNativeBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(IOUtil.java</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">223</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">......</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="问题定位" tabindex="-1">问题定位 <a class="header-anchor" href="#问题定位" aria-label="Permalink to “问题定位”">​</a></h2><p><code>Caused by: Connection reset by peer</code>根据日志可以知道，socket 连接被中断，连接中断的原因有很多，比如：</p><p>服务端或者客户端异常。 客户端连接超时中断。</p><p>查看日志，这段时间内也没啥异常信息，服务端也没异常重启，也没出现流量陡量的情况。想到之前在mysql遇到过的问题，mysql的连接如果超过8个小时(默认的时间)不连接，服务端为了节约资源，会主动把长时间没连接的客户端给中断掉，按照这个思路去排查问题，果然发现原因如出一辙。导致这个问题的原因有两个：</p><p>客户端采用长连接的方式连接服务端。 长时间不连ES，服务端会关闭连接。</p><h3 id="_1-客户端采用长连接的方式连接服务端-一直持有连接" tabindex="-1">1.客户端采用长连接的方式连接服务端, 一直持有连接 <a class="header-anchor" href="#_1-客户端采用长连接的方式连接服务端-一直持有连接" aria-label="Permalink to “1.客户端采用长连接的方式连接服务端, 一直持有连接”">​</a></h3><p>「ES High Level Rest Client」客户端和服务端的连接采用的是长连接，查阅源码发现客户端创建了client 连接池，每个client持有一个http连接，并且开启http的keep-alive策略复用连接, 策略默认是 -1 ，也就是不过期。</p><p><img src="`+t+`" alt="" loading="lazy"></p><h3 id="_2-长时间不连es-服务端会关闭连接" tabindex="-1">2.长时间不连ES，服务端会关闭连接 <a class="header-anchor" href="#_2-长时间不连es-服务端会关闭连接" aria-label="Permalink to “2.长时间不连ES，服务端会关闭连接”">​</a></h3><p>服务器会有TCP的Keepalive 经过一段时间如果没有操作就会自动断开连接功能，而ES默认就是取服务器的时长配置linux查看超时时间默认为两小时：</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看超时时间（单位秒）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@VM </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# cat /proc/sys/net/ipv4/tcp_keepalive_time</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">7200</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也就是说如果客户端超过两个小时没有连接服务端，服务端会清除掉连接。</p><h2 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to “解决方案”">​</a></h2><p>修改客户端的keepalive时间，以单机的ES为例，代码如下：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RestHighLevelClient </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">elasticsearchClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HttpHost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; httpHostsList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    httpHostsList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HttpHost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(uris, Integer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(port)));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    HttpHost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] httpHostsArray </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> HttpHost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[httpHostsList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    httpHostsArray </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> httpHostsList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(httpHostsArray);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RestClientBuilder builder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RestClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">builder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(httpHostsArray);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    builder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setHttpClientConfigCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(httpClientBuilder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> httpClientBuilder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setKeepAliveStrategy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((httpResponse, httpContext) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RestHighLevelClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(builder);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div>`,17)])])}const y=i(l,[["render",h]]);export{c as __pageData,y as default};
