# AI 社交稳定性建设

## 一、总体理解

> 在  **流式 AI 社交系统**里，
> 稳定性并不等于“请求不失败”，
> 而是：
> 
> **在任何失败发生时，
系统都能快速降级、持续输出、且对用户可解释。**

尤其是流式场景：

> **稳定性不在于“能不能流”，
而在于：
流得是否可控、可观测、可中断。**

这是我做所有稳定性设计的核心前提。

---

## 二、整体稳定性架构：多层限流 + 多级兜底

### 1️⃣ 多层限流与熔断设计（非常关键）

PolyBuzz 的负载来源是 **“人 × 角色 × 模型 × token”** 的乘积，
所以限流一定是 ​**多维度的，而不是单一 QPS**​。

我会拆成四层：

* **全局限流**
  防止整体模型 / 推理集群被打爆
* **用户级限流（分级）**
  * 普通用户
  * 核心用户 / 付费用户
    保证关键用户体验
* **角色级限流（分级）**
  防止单一热门角色被并发打穿
* **模型级限流**
  控制不同模型的并发流数、token 预算，
  防止高成本模型雪崩

> 本质不是“限制请求数”，
> 而是 ​**限制“并发流数 × token 消耗速率”**​。

---

## 三、会话与上下文层的稳定性兜底

### 2️⃣ 会话服务失败的处理策略

**典型失败场景：**

* Redis / DB 超时
* 同一用户同时和过多角色并发对话

**我的处理原则：**

> **会话是“可重建状态”，
不能成为系统单点。**

具体兜底策略：

* 老会话不可用 → **新建会话**
* 不阻塞用户输入
* 不强依赖历史状态

这样可以保证：

> 即使“记忆丢了”，
> 对话也能继续。

---

### 3️⃣ 上下文构建失败的降级路径

上下文是 AI 系统里​**最容易失控、也是最容易拖慢系统的部分**​。

我会明确拆分三类：

* **长期记忆获取失败**
* **短期上下文过长**
* **RAG 召回失败或过慢**

统一原则：

> **上下文是“增强项”，不是“强依赖”。**

兜底顺序非常清晰：

1. 长期记忆失败 → **直接跳过**
2. RAG 失败 / 超时 → **直接跳过**
3. 上下文过长 → **只保留短上下文**

> 宁可“记得少一点”，
> 也不能让请求卡死。

---

## 四、模型调用层的稳定性设计（流式重点）

### 4️⃣ 模型超时 & 首 token 兜底

在流式系统里，​**首 token 是用户“是否感知成功”的分水岭**​。

典型问题：

* 模型未超时，但迟迟不吐首 token
* 实际上用户已经认为“卡死了”

我的处理方式是：

* **首 token 超时判定**
* 触发后：
  * 中断当前流
  * 返回 ​**角色兜底回复**​（预设安全模板）
* 不等待模型自然失败

> 在 PolyBuzz，
> **“有回应但一般”，
远好于“完全没回应”。**

---

## 五、流式 AI 的稳定性指标体系（这是亮点）

### 5️⃣ 我不只看“成功率”，而是三类核心指标

#### （1）用户感知层（最重要）

* **TTFT（首 token 延迟）**
* **TPS（token 生产速率）**
* **对话成功率 / 中断率**

> 完整耗时反而是次要指标，
> 因为用户在“流”的过程中已经开始感知体验。

---

#### （2）模型层指标

* 模型调用超时率
* 熔断次数
* 首 token 超时比例

这些指标用来判断：

> 是模型不稳定，
> 还是流量不可控。

---

#### （3）系统层指标

* Redis 命中率 / 延迟
* 向量库（RAG）查询延迟
* 上下文构建耗时

这些决定：

> **AI 能不能“顺利走到模型那一步”。**

---

## 六、限流 & 熔断在流式场景下怎么做

### 6️⃣ 流式限流不是“请求级”，而是“流级”

我关注的是：

* **并发流数**
* **单流 token 预算**
* **整体 token 输出速率**

具体策略：

* 并发流数超限 → 拒绝新流
* token 消耗异常 → 中断低优先级流
* 首 token 异常 → 快速熔断

> 这套机制保证：
> 
> * 核心用户永远能流
> * 系统不会被慢流、卡流拖死

---

## 七、收官总结

> 我在稳定性设计上的核心理念是：
> 
> **AI 系统一定会失败，
但失败必须是“被设计过的失败”。**
> 
> 所以我关注的不是：
> 
> * 模型有多聪明
> 
> 而是：
> 
> * 出问题时能不能降级
> * 能不能快速中断
> * 用户是否始终“有感知、有反馈”
> 
> 这也是我认为
> 自己能在 PolyBuzz 这种高并发 AI 社交系统中
> 扛住稳定性责任的原因。
